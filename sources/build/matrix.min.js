var Utility,MatrixFX,Matrix,__extends=this&&this.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(Utility){Utility.fixDegrees=function(deg){return deg-360*Math.floor(deg/360)};var UID_CHARSET="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";function getUID(prefix,segmentCount,segmentLength){if(void 0===prefix&&(prefix="uid"),void 0===segmentCount&&(segmentCount=4),void 0===segmentLength&&(segmentLength=4),prefix.length<1||segmentCount<1||segmentLength<1)throw new Error("The specified arguments are not valid");for(var result=""+prefix,u=0;u<segmentCount;u++){result+="-";for(var i=0;i<segmentLength;i++)result+=""+UID_CHARSET[Math.floor(Math.random()*UID_CHARSET.length)]}return result}Utility.getUID=getUID,Utility.color_hsl=function(h,s,l){return void 0===s&&(s=100),void 0===l&&(l=50),"hsl("+h+", "+s+"%, "+l+"%)"},Utility.color_hsla=function(h,s,l,a){return void 0===s&&(s=100),void 0===l&&(l=50),void 0===a&&(a=1),"hsla("+h+", "+s+"%, "+l+"%, "+a+")"},Utility.color_rgb=function(r,g,b){return"rgb("+r+", "+g+", "+b+")"},Utility.color_rgba=function(r,g,b,a){return void 0===a&&(a=1),"rgba("+r+", "+g+", "+b+", "+a+")"},Utility.debug_create=function(parentSelector){var el;if(el=document.querySelector(parentSelector)){var id=getUID("debug"),span=document.createElement("span");return span.id=id,el.appendChild(span),{id:id}}return null},Utility.debug_value=function(handle,value){var el;handle&&handle.id&&(el=document.querySelector(handle.id))&&(el.innerHTML=value)};var GraphicCanvas=function(){function GraphicCanvas(_canvas){_canvas=_canvas||document.createElement("canvas"),this.canvas=_canvas,this.ctx=this.canvas.getContext("2d")}return GraphicCanvas.prototype.resize=function(width,height){this.canvas.width=width,this.canvas.height=height},GraphicCanvas.prototype.getBuffer=function(){return this.canvas},GraphicCanvas}();Utility.GraphicCanvas=GraphicCanvas}(Utility=Utility||{}),function(MatrixFX){var FX=function(){function FX(){this.buffer=document.createElement("canvas"),this.ctx=this.buffer.getContext("2d")}return FX.prototype.fx_buffer=function(width,height){this.buffer.width=width,this.buffer.height=height},FX.prototype.fx_render=function(interval,width,height){return this.ctx.clearRect(0,0,width,height),this.render(interval,width,height),this.buffer},FX}(),BasicColumnFX=function(_super){function BasicColumnFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.hueOffset=0,_this}return __extends(BasicColumnFX,_super),BasicColumnFX.prototype.render=function(interval,width,height){for(var colHue=360/(width/Matrix.COLUMN_SIZE),x=0;x<width;x+=Matrix.COLUMN_SIZE)this.ctx.fillStyle=Utility.color_hsl(Utility.fixDegrees(this.hueOffset-colHue*(x/Matrix.COLUMN_SIZE))),this.ctx.fillRect(x,0,Matrix.COLUMN_SIZE,height);this.hueOffset=Utility.fixDegrees(this.hueOffset+colHue)},BasicColumnFX}(MatrixFX.FX=FX);MatrixFX.BasicColumnFX=BasicColumnFX;var BasicLetterFX=function(_super){function BasicLetterFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.hueOffset=0,_this}return __extends(BasicLetterFX,_super),BasicLetterFX.prototype.render=function(interval,width,height){for(var colHue=360/(width/Matrix.COLUMN_SIZE),rowHue=360/(height/Matrix.COLUMN_SIZE),y=0;y<height;y+=Matrix.COLUMN_SIZE)for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)this.ctx.fillStyle=Utility.color_hsl(Utility.fixDegrees(this.hueOffset-colHue*(x/Matrix.COLUMN_SIZE)-rowHue*(y/Matrix.COLUMN_SIZE))),this.ctx.fillRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE);this.hueOffset=Utility.fixDegrees(this.hueOffset+rowHue)},BasicLetterFX}(FX);MatrixFX.BasicLetterFX=BasicLetterFX}(MatrixFX=MatrixFX||{}),function(Matrix){Matrix.DEFAULT_SIZE=300,Matrix.DEFAULT_COLOR="#44ff00",Matrix.DEFAULT_SYMBOLS="ｦｱｳｴｵｶｷｹｺｻｼｽｾｿﾀﾂﾃﾅﾆﾇﾈﾊﾋﾎﾏﾐﾑﾒﾓﾔﾕﾗﾘﾜ日(+*;)-|2589Z",Matrix.DEFAULT_SPEED=1,Matrix.DEFAULT_LINE_LENGTH=16,Matrix.DEFAULT_ROTATION=0,Matrix.DEFAULT_UPDATE_RATE=32,Matrix.DEFAULT_FX=new MatrixFX.BasicColumnFX,Matrix.DEFAULT_MOVE_CHANCE=.51,Matrix.DEFAULT_MUTATION_CHANCE=.1,Matrix.COLUMN_SIZE=12,Matrix.MAX_SPEED=32;var canvas,ctx,characters,characterSizes,created=!(Matrix.MAX_LINE_LENGTH=32),width=Matrix.DEFAULT_SIZE,height=Matrix.DEFAULT_SIZE,color=Matrix.DEFAULT_COLOR;function convertSymbols(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),characterSizes=[];for(var i=0,l=(characters=_symbols).length;i<l;i++)characterSizes[i]=ctx.measureText(characters[i]).width/2}function random_char(){return Math.floor(Math.random()*characters.length)}var Settings,RenderEngine,speed=Matrix.DEFAULT_SPEED,lineLength=Matrix.DEFAULT_LINE_LENGTH,rotation=Matrix.DEFAULT_ROTATION,ups=Matrix.DEFAULT_UPDATE_RATE,useFX=!1,fx=Matrix.DEFAULT_FX,moveChance=Matrix.DEFAULT_MOVE_CHANCE,mutationChance=Matrix.DEFAULT_MUTATION_CHANCE;function resize(_width,_height){void 0===_width&&(_width=Matrix.DEFAULT_SIZE),void 0===_height&&(_height=Matrix.DEFAULT_SIZE),created&&(width=_width,height=_height,canvas.width=_width,canvas.height=_height,fx.fx_buffer(_width,_height),RenderEngine.recalculate_columns())}Matrix.create=function(selector,settings){var _canvas=document.querySelector(selector);"canvas"==_canvas.tagName.toLowerCase()&&(created=!0,ctx=(canvas=_canvas).getContext("2d"),resize(Matrix.DEFAULT_SIZE,Matrix.DEFAULT_SIZE),convertSymbols(Matrix.DEFAULT_SYMBOLS),settings&&(settings.size&&resize(settings.size.width,settings.size.height),settings.color&&Settings.setColor(settings.color),settings.symbols&&Settings.setSymbols(settings.symbols),settings.speed&&Settings.setSpeed(settings.speed),settings.lineLength&&Settings.setLineLength(settings.lineLength),settings.rotation&&Settings.setRotation(settings.rotation),settings.updateRate&&Settings.setUpdateRate(settings.updateRate),null!=settings.useFX&&Settings.setUseFX(settings.useFX),settings.fx&&settings.fx.render&&Settings.setFX(settings.fx),settings.moveChance&&Settings.setMoveChance(settings.moveChance),settings.mutationChance&&Settings.setMutationChance(settings.mutationChance)))},Matrix.start=function(){RenderEngine.start()},Matrix.resize=resize,function(Settings){Settings.setColor=function(_color){void 0===_color&&(_color=Matrix.DEFAULT_COLOR),color=_color},Settings.getColor=function(){return color},Settings.setSymbols=function(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),convertSymbols(_symbols),RenderEngine.recalculate_columns()},Settings.getSymbols=function(){return characters},Settings.setSpeed=function(_speed){void 0===_speed&&(_speed=Matrix.DEFAULT_SPEED),(_speed<1||_speed>Matrix.MAX_SPEED)&&(_speed=Matrix.DEFAULT_SPEED),speed=_speed},Settings.getSpeed=function(){return speed},Settings.setLineLength=function(_lineLength){void 0===_lineLength&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),(_lineLength<1||_lineLength>Matrix.MAX_LINE_LENGTH)&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),lineLength=_lineLength},Settings.getLineLength=function(){return lineLength},Settings.setRotation=function(_rotation){void 0===_rotation&&(_rotation=Matrix.DEFAULT_ROTATION),rotation=Utility.fixDegrees(_rotation)},Settings.getRotation=function(){return rotation},Settings.setUpdateRate=function(_ups){void 0===_ups&&(_ups=Matrix.DEFAULT_UPDATE_RATE),_ups<1&&(_ups=Matrix.DEFAULT_UPDATE_RATE),ups=_ups},Settings.getUpdateRate=function(){return ups},Settings.setUseFX=function(_useFX){void 0===_useFX&&(_useFX=!1),useFX=_useFX},Settings.getUseFX=function(){return useFX},Settings.setFX=function(_fx){void 0===_fx&&(_fx=Matrix.DEFAULT_FX),(fx=_fx).fx_buffer(width,height)},Settings.getFX=function(){return fx},Settings.setMoveChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MOVE_CHANCE),moveChance=_chance},Settings.getMoveChance=function(){return moveChance},Settings.setMutationChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MUTATION_CHANCE),mutationChance=_chance},Settings.getMutationChance=function(){return mutationChance}}(Settings=Matrix.Settings||(Matrix.Settings={})),function(RenderEngine){var columns=[];function create_segment(){var hLineLength=lineLength/2;return{delay:Math.ceil(5+15*Math.random()),y:0,letters:[],length:Math.ceil(hLineLength+Math.random()*hLineLength)}}RenderEngine.recalculate_columns=function(){columns=[],paint_reset();for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)columns.push({x:x,segments:[create_segment()]})};var bg,fxBuffer,columnsAccumulator=0,colorAccumulator=0;function render_columns(){if(1e3/speed<=columnsAccumulator){ctx.beginPath(),ctx.clearRect(0,0,width,height),ctx.save(),ctx.globalAlpha=.3,ctx.drawImage(bg.getBuffer(),0,0),ctx.restore();for(var _i=0,columns_1=columns;_i<columns_1.length;_i++){for(var l_Column=columns_1[_i],move=Math.random()<moveChance,needsNext=!0,_a=0,_b=l_Column.segments;_a<_b.length;_a++){var l_Segment=_b[_a];if(0<l_Segment.delay){if(needsNext=!1,!move)continue;--l_Segment.delay}else{var changedLetter=!0;move&&(changedLetter=!1,l_Segment.letters.length<l_Segment.length?(l_Segment.letters.push(random_char()),needsNext=!1):(ctx.beginPath(),ctx.clearRect(l_Column.x,l_Segment.y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),l_Segment.y+=Matrix.COLUMN_SIZE));for(var i=0,l=l_Segment.letters.length;i<l;i++){var letter=l_Segment.letters[i];!changedLetter&&Math.random()<mutationChance?(changedLetter=!0,letter=random_char(),l_Segment.letters[i]=letter,x=l_Column.x,y=l_Segment.y+Matrix.COLUMN_SIZE*i,ctx.beginPath(),ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.save(),ctx.globalAlpha=.3,ctx.fillStyle="#000",ctx.beginPath(),ctx.fillRect(x+3,y+1,Matrix.COLUMN_SIZE-6,Matrix.COLUMN_SIZE-2),ctx.restore()):function(char,x,y){ctx.beginPath(),ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.fillStyle="#000",ctx.beginPath(),ctx.fillText(characters[char],x+6-characterSizes[char],y+2,Matrix.COLUMN_SIZE)}(letter,l_Column.x,l_Segment.y+Matrix.COLUMN_SIZE*i)}}}move&&needsNext&&l_Column.segments.push(create_segment()),l_Column.segments=l_Column.segments.filter(function(segment){return segment.y-Matrix.COLUMN_SIZE*segment.length<height})}columnsAccumulator=0}var x,y}function paint_reset(){ctx.clearRect(0,0,width,height),ctx.scale(1.2,1.2),bg&&bg.render()}RenderEngine.start=function(){bg=new BG,paint_reset();var lastRender=0;window.requestAnimationFrame(function loop(timestamp){var delta=timestamp-lastRender;columnsAccumulator+=delta,render_columns(),colorAccumulator+=delta,function(delta){ctx.save(),ctx.globalCompositeOperation="source-atop",useFX?((!fxBuffer||1e3/ups<=colorAccumulator)&&(fxBuffer=fx.fx_render(delta,width,height),colorAccumulator=0),ctx.drawImage(fxBuffer,0,0)):(ctx.fillStyle=color,ctx.beginPath(),ctx.fillRect(0,0,width,height)),ctx.restore()}(delta),lastRender=timestamp,window.requestAnimationFrame(loop)})};var BG=function(_super){function BG(){return _super.call(this)||this}return __extends(BG,_super),BG.prototype.render=function(){this.resize(width,height),this.ctx.clearRect(0,0,width,height),this.ctx.fillStyle="#000000";for(var y=0;y<height;y+=Matrix.COLUMN_SIZE)for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)this.ctx.beginPath(),this.ctx.fillRect(x+5,y+5,2,2)},BG}(Utility.GraphicCanvas)}(RenderEngine=RenderEngine||{})}(Matrix=Matrix||{});