var Utility,MatrixFX,Matrix,__extends=this&&this.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(Utility){Utility.fixDegrees=function(deg){return deg-360*Math.floor(deg/360)},Utility.fixFloat=function(val,decimals){return void 0===decimals&&(decimals=100),~~(val*decimals)/decimals};var UID_CHARSET="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";Utility.getUID=function(prefix,segmentCount,segmentLength){if(void 0===prefix&&(prefix="uid"),void 0===segmentCount&&(segmentCount=4),void 0===segmentLength&&(segmentLength=4),prefix.length<1||segmentCount<1||segmentLength<1)throw new Error("The specified arguments are not valid");for(var result=""+prefix,u=0;u<segmentCount;u++){result+="-";for(var i=0;i<segmentLength;i++)result+=""+UID_CHARSET[Math.floor(Math.random()*UID_CHARSET.length)]}return result},Utility.color_hsl=function(h,s,l){return void 0===s&&(s=100),void 0===l&&(l=50),"hsl("+h+", "+s+"%, "+l+"%)"},Utility.color_hsla=function(h,s,l,a){return void 0===s&&(s=100),void 0===l&&(l=50),void 0===a&&(a=1),"hsla("+h+", "+s+"%, "+l+"%, "+a+")"},Utility.color_rgb=function(r,g,b){return"rgb("+r+", "+g+", "+b+")"},Utility.color_rgba=function(r,g,b,a){return void 0===a&&(a=1),"rgba("+r+", "+g+", "+b+", "+a+")"};var Buffer=function(){function Buffer(options){this.allowResize=!0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),options&&(options.width&&(this.canvas.width=options.width),options.height&&(this.canvas.height=options.height),null!=options.allowResize&&(this.allowResize=options.allowResize))}return Buffer.prototype.width=function(){return this.canvas.width},Buffer.prototype.height=function(){return this.canvas.height},Buffer.prototype.html_canvas=function(){return this.canvas},Buffer.prototype.resize=function(width,height){this.allowResize&&(this.canvas.width=width,this.canvas.height=height,this.on_resize())},Buffer.prototype.drawTo=function(targetContext,width,height){targetContext.drawImage(this.html_canvas(),0,0,width,height)},Buffer}();Utility.Buffer=Buffer}(Utility=Utility||{}),function(MatrixFX){var FX=function(_super){function FX(options){return _super.call(this,options)||this}return __extends(FX,_super),FX}(Utility.Buffer),BasicColorFX=function(_super){function BasicColorFX(){return _super.call(this,{width:1,height:1,allowResize:!1})||this}return __extends(BasicColorFX,_super),BasicColorFX.prototype.setColor=function(_color){this.ctx.fillStyle=_color,this.draw()},BasicColorFX.prototype.getColor=function(){return this.ctx.fillStyle},BasicColorFX.prototype.on_resize=function(){},BasicColorFX.prototype.draw=function(){this.ctx.beginPath(),this.ctx.fillRect(0,0,1,1)},BasicColorFX}(MatrixFX.FX=FX),BasicColumnFX=function(_super){function BasicColumnFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.hueOffset=0,_this.colCount=0,_this.colHue=0,_this}return __extends(BasicColumnFX,_super),BasicColumnFX.prototype.resize=function(width,height){this.colCount=Math.ceil(width/Matrix.COLUMN_SIZE),this.colHue=360/this.colCount,this.canvas.width=this.colCount,this.canvas.height=1,this.draw()},BasicColumnFX.prototype.on_resize=function(){},BasicColumnFX.prototype.draw=function(){for(var x=0;x<this.colCount;x++)this.ctx.fillStyle=Utility.color_hsl(Utility.fixDegrees(this.hueOffset-this.colHue*x)),this.ctx.beginPath(),this.ctx.fillRect(x,0,1,1);this.hueOffset=Utility.fixDegrees(this.hueOffset+this.colHue)},BasicColumnFX}(FX),BasicDiagonalFX=function(_super){function BasicDiagonalFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.colors=["#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ff00","#00ff55","#00ffaa","#00ffff","#00aaff","#0055ff","#0000ff","#5500ff","#aa00ff","#ff00ff","#ff00aa","#ff0055"],_this.colCount=0,_this.rowCount=0,_this.yOffset=0,_this}return __extends(BasicDiagonalFX,_super),BasicDiagonalFX.prototype.drawTo=function(targetContext,width,height){this.yOffset>=this.rowCount&&(this.yOffset=0),this.yOffset--,targetContext.drawImage(this.html_canvas(),0,this.yOffset,width,height)},BasicDiagonalFX.prototype.on_resize=function(){this.colCount=this.width()/Matrix.COLUMN_SIZE,this.rowCount=this.height()/Matrix.COLUMN_SIZE,this.canvas.width=this.colCount,this.canvas.height=2*this.rowCount,this.ctx.beginPath(),this.ctx.clearRect(0,0,this.colCount,2*this.rowCount);var gradientBufferCanvas=document.createElement("canvas"),gradientBufferCtx=gradientBufferCanvas.getContext("2d");gradientBufferCanvas.width=this.colCount,gradientBufferCanvas.height=this.rowCount;var gradient=this.ctx.createLinearGradient(0,0,this.colCount,this.rowCount);gradient.addColorStop(0,this.colors[0]);for(var gradientStep=1/(this.colors.length-1),at=gradientStep,i=1,l=this.colors.length;i<l;i++)gradient.addColorStop(Math.min(1,at),this.colors[i]),at+=gradientStep;gradient.addColorStop(1,this.colors[0]),gradientBufferCtx.fillStyle=gradient,gradientBufferCtx.beginPath(),gradientBufferCtx.fillRect(0,0,this.colCount,this.rowCount),this.ctx.drawImage(gradientBufferCanvas,0,0,this.colCount,this.rowCount),this.ctx.drawImage(gradientBufferCanvas,this.colCount,this.rowCount,-this.colCount,this.rowCount)},BasicDiagonalFX.prototype.draw=function(){},BasicDiagonalFX}(FX);MatrixFX.BUILTIN_FX_COLOR=new BasicColorFX,MatrixFX.BUILTIN_FX_COLUMNS=new BasicColumnFX,MatrixFX.BUILTIN_FX_DIAGONAL=new BasicDiagonalFX}(MatrixFX=MatrixFX||{}),function(Matrix){Matrix.DEFAULT_COLOR="#44ff00",Matrix.DEFAULT_BACKGROUND_COLOR="#000",Matrix.DEFAULT_SYMBOLS="ｦｱｳｴｵｶｷｹｺｻｼｽｾｿﾀﾂﾃﾅﾆﾇﾈﾊﾋﾎﾏﾐﾑﾒﾓﾔﾕﾗﾘﾜ日(+*;)-|2589Z",Matrix.DEFAULT_SPEED=16,Matrix.DEFAULT_LINE_LENGTH=16,Matrix.DEFAULT_UPDATE_RATE_FX=32,Matrix.DEFAULT_FX=MatrixFX.BUILTIN_FX_COLOR,Matrix.DEFAULT_COMPOSITE_ALPHA=.3,Matrix.DEFAULT_COMPOSITE_MUTATION=!0,Matrix.DEFAULT_MOVE_CHANCE=.51,Matrix.DEFAULT_WAIT_TIME=20,Matrix.DEFAULT_MUTATION_CHANCE=.1,Matrix.DEFAULT_OVERLAY_MODE=1,Matrix.DEFAULT_LETTER_MUTATION_MODE=0,Matrix.COLUMN_SIZE=12,Matrix.MAX_SPEED=32;var width,height,container,fgCanvas,fgCtx,canvas,ctx,bgCanvas,bgCtx,characters,characterSizes,created=!(Matrix.MAX_LINE_LENGTH=32),started=!1;function convertSymbols(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),characterSizes=[];for(var i=0,l=(characters=_symbols).length;i<l;i++)characterSizes[i]=ctx.measureText(characters[i]).width/2}function random_char(){return Math.floor(Math.random()*characters.length)}var RenderEngine,backgroundColor=Matrix.DEFAULT_BACKGROUND_COLOR,speed=Matrix.DEFAULT_SPEED,lineLength=Matrix.DEFAULT_LINE_LENGTH,upsFX=Matrix.DEFAULT_UPDATE_RATE_FX,fx=Matrix.DEFAULT_FX,compositeAlpha=Matrix.DEFAULT_COMPOSITE_ALPHA,compositeMutation=Matrix.DEFAULT_COMPOSITE_MUTATION,moveChance=Matrix.DEFAULT_MOVE_CHANCE,mutationChance=Matrix.DEFAULT_MUTATION_CHANCE,overlayMode=Matrix.DEFAULT_OVERLAY_MODE,letterMutationMode=Matrix.DEFAULT_LETTER_MUTATION_MODE;function resize(){created?(width=container.clientWidth,height=container.clientHeight,fgCanvas.width=width,fgCanvas.height=height,canvas.width=width,canvas.height=height,bgCanvas.width=width,bgCanvas.height=height,fx.resize(width,height),RenderEngine.recalculate_columns()):console.error("Matrix : Cannot resize before creation.")}function resizeContainer(_width,_height){created?(container.style.width=_width,container.style.height=_height,resize()):console.error("Matrix : Cannot resize container before creation.")}Matrix.create=function(selector,size){if(container=document.querySelector(selector)){created=!0,container.style.overflow="hidden",fgCanvas=document.createElement("canvas"),canvas=document.createElement("canvas"),bgCanvas=document.createElement("canvas");fgCanvas.setAttribute("style","z-index: 3; position: absolute;"),canvas.setAttribute("style","z-index: 2; position: absolute;"),bgCanvas.setAttribute("style","z-index: 1; position: absolute;"),container.append(fgCanvas,canvas,bgCanvas),fgCtx=fgCanvas.getContext("2d"),ctx=canvas.getContext("2d"),bgCtx=bgCanvas.getContext("2d"),convertSymbols(Matrix.DEFAULT_SYMBOLS),Matrix.DEFAULT_FX.setColor(Matrix.DEFAULT_COLOR),size&&resizeContainer(size.width,size.height)}else console.error("Matrix : Could not find the container specified.")},Matrix.start=function(){started?console.error("Matrix : Cannot start twice."):(started=!0,resize(),RenderEngine.start())},Matrix.resize=resize,Matrix.resizeContainer=resizeContainer,Matrix.getContainer=function(){return container},Matrix.debug_fx=function(){if(started)throw new Error("Cannot debug fx if already started!");RenderEngine.debug_fx()},function(Settings){function checkCreated(settingName){if(!created)throw new Error('Cannot set setting "'+settingName+'" before creation!')}Settings.setColor=function(_color){return void 0===_color&&(_color=Matrix.DEFAULT_COLOR),Matrix.DEFAULT_FX.setColor(_color),this},Settings.getColor=function(){return Matrix.DEFAULT_FX.getColor()},Settings.setBackgroundColor=function(_backgroundColor){return void 0===_backgroundColor&&(_backgroundColor=Matrix.DEFAULT_BACKGROUND_COLOR),backgroundColor=_backgroundColor,bgCtx.fillStyle=backgroundColor,bgCtx.beginPath(),bgCtx.fillRect(0,0,width,height),fgCtx.fillStyle=backgroundColor,this},Settings.getBackgroundColor=function(){return backgroundColor},Settings.setSymbols=function(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),checkCreated("symbols"),convertSymbols(_symbols),RenderEngine.recalculate_columns()},Settings.getSymbols=function(){return characters},Settings.setSpeed=function(_speed){void 0===_speed&&(_speed=Matrix.DEFAULT_SPEED),(_speed<1||_speed>Matrix.MAX_SPEED)&&(_speed=Matrix.DEFAULT_SPEED),speed=_speed},Settings.getSpeed=function(){return speed},Settings.setLineLength=function(_lineLength){void 0===_lineLength&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),(_lineLength<1||_lineLength>Matrix.MAX_LINE_LENGTH)&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),lineLength=_lineLength},Settings.getLineLength=function(){return lineLength},Settings.setUpdateRateFX=function(_ups){void 0===_ups&&(_ups=Matrix.DEFAULT_UPDATE_RATE_FX),_ups<1&&(_ups=Matrix.DEFAULT_UPDATE_RATE_FX),upsFX=_ups},Settings.getUpdateRate=function(){return upsFX},Settings.setFX=function(_fx){void 0===_fx&&(_fx=Matrix.DEFAULT_FX),checkCreated("fx"),(fx=_fx).resize(width,height)},Settings.getFX=function(){return fx},Settings.setCompositeAlpha=function(_alpha){void 0===_alpha&&(_alpha=Matrix.DEFAULT_COMPOSITE_ALPHA),compositeAlpha=_alpha,fgCtx.globalAlpha=compositeAlpha},Settings.getCompositeAlpha=function(){return compositeAlpha},Settings.setCompositeMutation=function(_compositeMutation){compositeMutation=_compositeMutation},Settings.getCompositeMutation=function(){return compositeMutation},Settings.setMoveChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MOVE_CHANCE),moveChance=_chance},Settings.getMoveChance=function(){return moveChance},Settings.setMutationChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MUTATION_CHANCE),mutationChance=_chance},Settings.getMutationChance=function(){return mutationChance},Settings.setOverlayMode=function(_overlayMode){void 0===_overlayMode&&(_overlayMode=Matrix.DEFAULT_OVERLAY_MODE),overlayMode=_overlayMode},Settings.getOverlayMode=function(){return overlayMode},Settings.setLetterMutationMode=function(_letterMutationMode){void 0===_letterMutationMode&&(_letterMutationMode=Matrix.DEFAULT_LETTER_MUTATION_MODE),letterMutationMode=_letterMutationMode},Settings.getLetterMutationMode=function(){return letterMutationMode}}(Matrix.Settings||(Matrix.Settings={})),function(RenderEngine){var columns=[];function create_segment(){var hLineLength=lineLength/2;return{delay:Math.ceil(5+15*Math.random()),y:0,letters:[],length:Math.ceil(hLineLength+Math.random()*hLineLength)}}RenderEngine.recalculate_columns=function(){columns=[],paint_reset();for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)columns.push({wait:Matrix.DEFAULT_WAIT_TIME+Matrix.DEFAULT_WAIT_TIME*moveChance*Math.random(),x:x,segments:[create_segment()]})};var background,columnsAccumulator=0,colorAccumulator=0;function render_columns(delta){if(1e3/speed<=columnsAccumulator){ctx.clearRect(0,0,width,height),fgCtx.clearRect(0,0,width,height),ctx.globalAlpha=compositeAlpha,ctx.drawImage(background.html_canvas(),0,0),ctx.globalAlpha=1;for(var _i=0,columns_1=columns;_i<columns_1.length;_i++){var l_Column=columns_1[_i],move=(l_Column.wait-=delta)<=0;move&&(l_Column.wait=Matrix.DEFAULT_WAIT_TIME+Matrix.DEFAULT_WAIT_TIME*moveChance*Math.random());for(var needsNext=move,_a=0,_b=l_Column.segments;_a<_b.length;_a++){var l_Segment=_b[_a];if(0<l_Segment.delay){if(needsNext=!1,!move)continue;--l_Segment.delay}else{var changedLetter=!0;move&&(changedLetter=!1,l_Segment.letters.length<l_Segment.length?(l_Segment.letters.push(random_char()),needsNext=!1):(ctx.clearRect(l_Column.x,l_Segment.y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),l_Segment.y+=Matrix.COLUMN_SIZE)),(0==letterMutationMode||2==letterMutationMode)&&1<l_Segment.letters.length&&(l_Segment.letters.shift(),l_Segment.letters.push(random_char()));for(var i=0,l=l_Segment.letters.length;i<l;i++){!changedLetter&&(1==letterMutationMode||2==letterMutationMode)&&Math.random()<mutationChance?(changedLetter=!0,l_Segment.letters[i]=random_char(),paint_letter_mutation(l_Column.x,l_Segment.y+Matrix.COLUMN_SIZE*i)):(paint_letter(l_Segment.letters[i],l_Column.x,l_Segment.y+Matrix.COLUMN_SIZE*i),1==overlayMode&&i+1<l&&(fgCtx.beginPath(),fgCtx.fillRect(l_Column.x,l_Segment.y-8+Matrix.COLUMN_SIZE*i,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE)))}}}needsNext&&l_Column.segments.push(create_segment()),l_Column.segments=l_Column.segments.filter(function(segment){return segment.y-Matrix.COLUMN_SIZE*segment.length<height})}0==overlayMode&&(fgCtx.beginPath(),fgCtx.fillRect(0,0,width,height)),columnsAccumulator=0}}function render_composite_color(){ctx.globalCompositeOperation="source-atop",1e3/upsFX<=colorAccumulator&&(fx.draw(),colorAccumulator=0),fx.drawTo(ctx,width,height),ctx.globalCompositeOperation="source-over"}function render_process_debugFX(delta){1e3/upsFX<=(colorAccumulator+=delta)&&(ctx.fillRect(0,0,width,height),render_composite_color())}var render_process=function(delta){columnsAccumulator+=delta,render_columns(delta),colorAccumulator+=delta,render_composite_color()};function paint_reset(){ctx.clearRect(0,0,width,height),ctx.scale(1.2,1.2),background&&background.resize(width,height),bgCtx.fillStyle=backgroundColor,bgCtx.scale(1.2,1.2),bgCtx.beginPath(),bgCtx.fillRect(0,0,width,height),fgCtx.globalAlpha=compositeAlpha,fgCtx.scale(1.2,1.2)}function paint_letter(char,x,y){ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.beginPath(),ctx.strokeText(characters[char],x+6-characterSizes[char],y+2,Matrix.COLUMN_SIZE)}function paint_letter_mutation(x,y){ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.globalAlpha=compositeMutation?compositeAlpha:1,ctx.beginPath(),ctx.fillRect(x+2,y-8,Matrix.COLUMN_SIZE-4,Matrix.COLUMN_SIZE),ctx.globalAlpha=1}RenderEngine.debug_fx=function(){render_process=render_process_debugFX},RenderEngine.start=function(){ctx.strokeStyle="#000",ctx.fillStyle="#000",background=new BGBuffer,paint_reset();var lastRender=0;window.requestAnimationFrame(function loop(timestamp){render_process(timestamp-lastRender),lastRender=timestamp,window.requestAnimationFrame(loop)})};var BGBuffer=function(_super){function BGBuffer(){var _this=_super.call(this)||this;return _this.ctx.fillStyle="#000",_this}return __extends(BGBuffer,_super),BGBuffer.prototype.on_resize=function(){this.draw()},BGBuffer.prototype.draw=function(){this.ctx.clearRect(0,0,this.width(),this.height());for(var y=0;y<this.height();y+=Matrix.COLUMN_SIZE)for(var x=0;x<this.width();x+=Matrix.COLUMN_SIZE)this.ctx.beginPath(),this.ctx.fillRect(x+5,y+5,2,2)},BGBuffer}(Utility.Buffer)}(RenderEngine=RenderEngine||{})}(Matrix=Matrix||{});