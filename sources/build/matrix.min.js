var Utility,MatrixFX,Matrix,__extends=this&&this.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(Utility){Utility.fixDegrees=function(deg){return deg-360*Math.floor(deg/360)},Utility.fixFloat=function(val,decimals){return void 0===decimals&&(decimals=100),~~(val*decimals)/decimals};var UID_CHARSET="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";Utility.getUID=function(prefix,segmentCount,segmentLength){if(void 0===prefix&&(prefix="uid"),void 0===segmentCount&&(segmentCount=4),void 0===segmentLength&&(segmentLength=4),prefix.length<1||segmentCount<1||segmentLength<1)throw new Error("The specified arguments are not valid");for(var result=""+prefix,u=0;u<segmentCount;u++){result+="-";for(var i=0;i<segmentLength;i++)result+=""+UID_CHARSET[Math.floor(Math.random()*UID_CHARSET.length)]}return result},Utility.color_hsl=function(h,s,l){return void 0===s&&(s=100),void 0===l&&(l=50),"hsl("+h+", "+s+"%, "+l+"%)"},Utility.color_hsla=function(h,s,l,a){return void 0===s&&(s=100),void 0===l&&(l=50),void 0===a&&(a=1),"hsla("+h+", "+s+"%, "+l+"%, "+a+")"},Utility.color_rgb=function(r,g,b){return"rgb("+r+", "+g+", "+b+")"},Utility.color_rgba=function(r,g,b,a){return void 0===a&&(a=1),"rgba("+r+", "+g+", "+b+", "+a+")"}}(Utility=Utility||{}),function(MatrixFX){var FX=function(){function FX(){this.buffer=document.createElement("canvas"),this.ctx=this.buffer.getContext("2d")}return FX.prototype.fx_buffer=function(width,height){this.buffer.width=width,this.buffer.height=height},FX.prototype.fx_render=function(interval,width,height){return this.ctx.clearRect(0,0,width,height),this.render(interval,width,height),this.buffer},FX.prototype.fx_draw=function(_ctx,width,height){_ctx.drawImage(this.buffer,0,0)},FX}(),BasicColumnFX=function(_super){function BasicColumnFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.hueOffset=0,_this.colCount=0,_this.colHue=0,_this}return __extends(BasicColumnFX,_super),BasicColumnFX.prototype.fx_buffer=function(width,height){this.colCount=width/Matrix.COLUMN_SIZE,this.colHue=360/this.colCount,_super.prototype.fx_buffer.call(this,this.colCount,1)},BasicColumnFX.prototype.fx_draw=function(_ctx,width,height){_ctx.drawImage(this.buffer,0,0,width,height)},BasicColumnFX.prototype.render=function(interval,width,height){for(var x=0;x<this.colCount;x++)this.ctx.fillStyle=Utility.color_hsl(Utility.fixDegrees(this.hueOffset-this.colHue*x)),this.ctx.fillRect(x,0,1,1);this.hueOffset=Utility.fixDegrees(this.hueOffset+this.colHue)},BasicColumnFX}(MatrixFX.FX=FX);MatrixFX.BasicColumnFX=BasicColumnFX;var BasicDiagonalFX=function(_super){function BasicDiagonalFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.colors=["#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ff00","#00ff55","#00ffaa","#00ffff","#00aaff","#0055ff","#0000ff","#5500ff","#aa00ff","#ff00ff","#ff00aa","#ff0055"],_this.colCount=0,_this.rowCount=0,_this}return __extends(BasicDiagonalFX,_super),BasicDiagonalFX.prototype.fx_buffer=function(width,height){this.colCount=width/Matrix.COLUMN_SIZE,this.rowCount=height/Matrix.COLUMN_SIZE,_super.prototype.fx_buffer.call(this,this.colCount,2*this.rowCount);var gradientBufferCanvas=document.createElement("canvas"),gradientBufferCtx=gradientBufferCanvas.getContext("2d");gradientBufferCanvas.width=this.colCount,gradientBufferCanvas.height=this.rowCount;var gradient=this.ctx.createLinearGradient(0,0,this.colCount,this.rowCount);gradient.addColorStop(0,this.colors[0]);for(var gradientStep=1/(this.colors.length-1),at=gradientStep,i=1,l=this.colors.length;i<l;i++)gradient.addColorStop(Math.min(1,at),this.colors[i]),at+=gradientStep;gradient.addColorStop(1,this.colors[0]),gradientBufferCtx.fillStyle=gradient,gradientBufferCtx.beginPath(),gradientBufferCtx.fillRect(0,0,this.colCount,this.rowCount),this.ctx.drawImage(gradientBufferCanvas,0,0,this.colCount,2*this.rowCount)},BasicDiagonalFX.prototype.fx_render=function(interval,width,height){return this.render(interval,width,height),this.buffer},BasicDiagonalFX.prototype.fx_draw=function(_ctx,width,height){_ctx.drawImage(this.buffer,0,0,width,height)},BasicDiagonalFX.prototype.render=function(interval,width,height){},BasicDiagonalFX}(FX);MatrixFX.BasicDiagonalFX=BasicDiagonalFX}(MatrixFX=MatrixFX||{}),function(Matrix){Matrix.DEFAULT_SIZE=300,Matrix.DEFAULT_COLOR="#44ff00",Matrix.DEFAULT_SYMBOLS="ｦｱｳｴｵｶｷｹｺｻｼｽｾｿﾀﾂﾃﾅﾆﾇﾈﾊﾋﾎﾏﾐﾑﾒﾓﾔﾕﾗﾘﾜ日(+*;)-|2589Z",Matrix.DEFAULT_SPEED=1,Matrix.DEFAULT_LINE_LENGTH=16,Matrix.DEFAULT_ROTATION=0,Matrix.DEFAULT_UPDATE_RATE_FX=32,Matrix.DEFAULT_FX=new MatrixFX.BasicColumnFX,Matrix.DEFAULT_COMPOSITE_ALPHA=.3,Matrix.DEFAULT_MOVE_CHANCE=.51,Matrix.DEFAULT_MUTATION_CHANCE=.1,Matrix.COLUMN_SIZE=12,Matrix.MAX_SPEED=32;var canvas,ctx,characters,characterSizes,created=!(Matrix.MAX_LINE_LENGTH=32),started=!1,width=Matrix.DEFAULT_SIZE,q_width=Matrix.DEFAULT_SIZE,height=Matrix.DEFAULT_SIZE,q_height=Matrix.DEFAULT_SIZE,color=Matrix.DEFAULT_COLOR;function convertSymbols(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),characterSizes=[];for(var i=0,l=(characters=_symbols).length;i<l;i++)characterSizes[i]=ctx.measureText(characters[i]).width/2}function random_char(){return Math.floor(Math.random()*characters.length)}var Settings,RenderEngine,speed=Matrix.DEFAULT_SPEED,lineLength=Matrix.DEFAULT_LINE_LENGTH,rotation=Matrix.DEFAULT_ROTATION,upsFX=Matrix.DEFAULT_UPDATE_RATE_FX,useFX=!1,fx=Matrix.DEFAULT_FX,compositeAlpha=Matrix.DEFAULT_COMPOSITE_ALPHA,moveChance=Matrix.DEFAULT_MOVE_CHANCE,mutationChance=Matrix.DEFAULT_MUTATION_CHANCE;function resize(_width,_height){if(void 0===_width&&(_width=Matrix.DEFAULT_SIZE),void 0===_height&&(_height=Matrix.DEFAULT_SIZE),!created)return q_width=_width,void(q_height=_height);width=_width,height=_height,canvas.width=_width,canvas.height=_height,fx.fx_buffer(_width,_height),RenderEngine.recalculate_columns()}Matrix.create=function(selector,settings){var _canvas=document.querySelector(selector);"canvas"==_canvas.tagName.toLowerCase()&&(created=!0,ctx=(canvas=_canvas).getContext("2d"),resize(q_width,q_height),convertSymbols(Matrix.DEFAULT_SYMBOLS),settings&&(settings.size&&resize(settings.size.width,settings.size.height),settings.color&&Settings.setColor(settings.color),settings.symbols&&Settings.setSymbols(settings.symbols),settings.speed&&Settings.setSpeed(settings.speed),settings.lineLength&&Settings.setLineLength(settings.lineLength),settings.rotation&&Settings.setRotation(settings.rotation),settings.updateRateFX&&Settings.setUpdateRateFX(settings.updateRateFX),null!=settings.useFX&&Settings.setUseFX(settings.useFX),settings.fx&&settings.fx.render&&Settings.setFX(settings.fx),settings.compositeAlpha&&Settings.setCompositeAlpha(settings.compositeAlpha),settings.moveChance&&Settings.setMoveChance(settings.moveChance),settings.mutationChance&&Settings.setMutationChance(settings.mutationChance)))},Matrix.start=function(){started||(started=!0,RenderEngine.start())},Matrix.resize=resize,Matrix.debug_fx=function(){if(started)throw new Error("Cannot debug fx if already started!");Settings.setUseFX(!0),RenderEngine.debug_fx()},function(Settings){function checkCreated(settingName){if(!created)throw new Error('Cannot set setting "'+settingName+'" before creation!')}Settings.setColor=function(_color){void 0===_color&&(_color=Matrix.DEFAULT_COLOR),color=_color},Settings.getColor=function(){return color},Settings.setSymbols=function(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),checkCreated("symbols"),convertSymbols(_symbols),RenderEngine.recalculate_columns()},Settings.getSymbols=function(){return characters},Settings.setSpeed=function(_speed){void 0===_speed&&(_speed=Matrix.DEFAULT_SPEED),(_speed<1||_speed>Matrix.MAX_SPEED)&&(_speed=Matrix.DEFAULT_SPEED),speed=_speed},Settings.getSpeed=function(){return speed},Settings.setLineLength=function(_lineLength){void 0===_lineLength&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),(_lineLength<1||_lineLength>Matrix.MAX_LINE_LENGTH)&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),lineLength=_lineLength},Settings.getLineLength=function(){return lineLength},Settings.setRotation=function(_rotation){void 0===_rotation&&(_rotation=Matrix.DEFAULT_ROTATION),checkCreated("rotation"),rotation=Utility.fixDegrees(_rotation)},Settings.getRotation=function(){return rotation},Settings.setUpdateRateFX=function(_ups){void 0===_ups&&(_ups=Matrix.DEFAULT_UPDATE_RATE_FX),_ups<1&&(_ups=Matrix.DEFAULT_UPDATE_RATE_FX),upsFX=_ups},Settings.getUpdateRate=function(){return upsFX},Settings.setUseFX=function(_useFX){void 0===_useFX&&(_useFX=!1),useFX=_useFX},Settings.getUseFX=function(){return useFX},Settings.setFX=function(_fx){void 0===_fx&&(_fx=Matrix.DEFAULT_FX),checkCreated("fx"),(fx=_fx).fx_buffer(width,height),fx.fx_render(0,width,height)},Settings.getFX=function(){return fx},Settings.setCompositeAlpha=function(_alpha){void 0===_alpha&&(_alpha=Matrix.DEFAULT_COMPOSITE_ALPHA),compositeAlpha=_alpha},Settings.getCompositeAlpha=function(){return compositeAlpha},Settings.setMoveChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MOVE_CHANCE),moveChance=_chance},Settings.getMoveChance=function(){return moveChance},Settings.setMutationChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MUTATION_CHANCE),mutationChance=_chance},Settings.getMutationChance=function(){return mutationChance}}(Settings=Matrix.Settings||(Matrix.Settings={})),function(RenderEngine){var columns=[];function create_segment(){var hLineLength=lineLength/2;return{delay:Math.ceil(5+15*Math.random()),y:0,letters:[],length:Math.ceil(hLineLength+Math.random()*hLineLength)}}RenderEngine.recalculate_columns=function(){columns=[],paint_reset();for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)columns.push({x:x,segments:[create_segment()]})};var background,columnsAccumulator=0,colorAccumulator=0;function render_columns(){if(1e3/speed<=columnsAccumulator){ctx.beginPath(),ctx.clearRect(0,0,width,height),ctx.globalAlpha=compositeAlpha,ctx.drawImage(background.getBuffer(),0,0),ctx.globalAlpha=1;for(var _i=0,columns_1=columns;_i<columns_1.length;_i++){for(var l_Column=columns_1[_i],move=Math.random()<moveChance,needsNext=!0,_a=0,_b=l_Column.segments;_a<_b.length;_a++){var l_Segment=_b[_a];if(0<l_Segment.delay){if(needsNext=!1,!move)continue;--l_Segment.delay}else{var changedLetter=!0;move&&(changedLetter=!1,l_Segment.letters.length<l_Segment.length?(l_Segment.letters.push(random_char()),needsNext=!1):(ctx.beginPath(),ctx.clearRect(l_Column.x,l_Segment.y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),l_Segment.y+=Matrix.COLUMN_SIZE));for(var i=0,l=l_Segment.letters.length;i<l;i++){var letter=l_Segment.letters[i];!changedLetter&&Math.random()<mutationChance?(changedLetter=!0,letter=random_char(),l_Segment.letters[i]=letter,paint_letter_mutation(l_Column.x,l_Segment.y+Matrix.COLUMN_SIZE*i)):paint_letter(letter,l_Column.x,l_Segment.y+Matrix.COLUMN_SIZE*i)}}}move&&needsNext&&l_Column.segments.push(create_segment()),l_Column.segments=l_Column.segments.filter(function(segment){return segment.y-Matrix.COLUMN_SIZE*segment.length<height})}columnsAccumulator=0}}function render_composite_color(delta){ctx.globalCompositeOperation="source-atop",useFX?(1e3/upsFX<=colorAccumulator&&(fx.fx_render(delta,width,height),colorAccumulator=0),fx.fx_draw(ctx,width,height)):(ctx.fillStyle=color,ctx.beginPath(),ctx.fillRect(0,0,width,height)),ctx.globalCompositeOperation="source-over",ctx.fillStyle="#000"}function render_process_debugFX(delta){1e3/upsFX<=(colorAccumulator+=delta)&&(ctx.fillRect(0,0,width,height),render_composite_color(delta))}var render_process=function(delta){columnsAccumulator+=delta,render_columns(),colorAccumulator+=delta,render_composite_color(delta)};function paint_reset(){ctx.clearRect(0,0,width,height),ctx.scale(1.2,1.2),background&&background.render()}function paint_letter(char,x,y){ctx.beginPath(),ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.beginPath(),ctx.fillText(characters[char],x+6-characterSizes[char],y+2,Matrix.COLUMN_SIZE)}function paint_letter_mutation(x,y){ctx.beginPath(),ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.globalAlpha=.3,ctx.beginPath(),ctx.fillRect(x+3,y+1,Matrix.COLUMN_SIZE-6,Matrix.COLUMN_SIZE-2),ctx.globalAlpha=1}RenderEngine.debug_fx=function(){render_process=render_process_debugFX},RenderEngine.start=function(){background=new BGBuffer,ctx.fillStyle="#000",paint_reset();var lastRender=0;window.requestAnimationFrame(function loop(timestamp){render_process(timestamp-lastRender),lastRender=timestamp,window.requestAnimationFrame(loop)})};var BGBuffer=function(){function BGBuffer(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#000"}return BGBuffer.prototype.render=function(){this.canvas.width=width,this.canvas.height=height,this.ctx.clearRect(0,0,width,height);for(var y=0;y<height;y+=Matrix.COLUMN_SIZE)for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)this.ctx.beginPath(),this.ctx.fillRect(x+5,y+5,2,2)},BGBuffer.prototype.getBuffer=function(){return this.canvas},BGBuffer}()}(RenderEngine=RenderEngine||{})}(Matrix=Matrix||{});