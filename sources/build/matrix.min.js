var Utility,MatrixFX,Matrix,__extends=this&&this.__extends||function(){var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(Utility){Utility.fixDegrees=function(deg){return deg-360*Math.floor(deg/360)},Utility.fixFloat=function(val,decimals){return void 0===decimals&&(decimals=100),~~(val*decimals)/decimals};var UID_CHARSET="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";Utility.getUID=function(prefix,segmentCount,segmentLength){if(void 0===prefix&&(prefix="uid"),void 0===segmentCount&&(segmentCount=4),void 0===segmentLength&&(segmentLength=4),prefix.length<1||segmentCount<1||segmentLength<1)throw new Error("The specified arguments are not valid");for(var result=""+prefix,u=0;u<segmentCount;u++){result+="-";for(var i=0;i<segmentLength;i++)result+=""+UID_CHARSET[Math.floor(Math.random()*UID_CHARSET.length)]}return result},Utility.color_hsl=function(h,s,l){return void 0===s&&(s=100),void 0===l&&(l=50),"hsl("+h+", "+s+"%, "+l+"%)"},Utility.color_hsla=function(h,s,l,a){return void 0===s&&(s=100),void 0===l&&(l=50),void 0===a&&(a=1),"hsla("+h+", "+s+"%, "+l+"%, "+a+")"},Utility.color_rgb=function(r,g,b){return"rgb("+r+", "+g+", "+b+")"},Utility.color_rgba=function(r,g,b,a){return void 0===a&&(a=1),"rgba("+r+", "+g+", "+b+", "+a+")"};var Buffer=function(){function Buffer(options){this.allowResize=!0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),options&&(options.width&&(this.canvas.width=options.width),options.height&&(this.canvas.height=options.height),null!=options.allowResize&&(this.allowResize=options.allowResize))}return Buffer.prototype.width=function(){return this.canvas.width},Buffer.prototype.height=function(){return this.canvas.height},Buffer.prototype.html_canvas=function(){return this.canvas},Buffer.prototype.resize=function(width,height){this.allowResize&&(this.canvas.width=width,this.canvas.height=height)},Buffer.prototype.drawTo=function(targetContext,width,height){targetContext.drawImage(this.html_canvas(),0,0,width,height)},Buffer}();Utility.Buffer=Buffer}(Utility=Utility||{}),function(MatrixFX){var FX=function(_super){function FX(options){return _super.call(this,options)||this}return __extends(FX,_super),FX}(Utility.Buffer),BasicColorFX=function(_super){function BasicColorFX(){return _super.call(this,{width:1,height:1,allowResize:!1})||this}return __extends(BasicColorFX,_super),BasicColorFX.prototype.setColor=function(_color){this.ctx.fillStyle=_color,this.draw()},BasicColorFX.prototype.getColor=function(){return this.ctx.fillStyle},BasicColorFX.prototype.on_resize=function(){},BasicColorFX.prototype.draw=function(){this.ctx.beginPath(),this.ctx.fillRect(0,0,1,1)},BasicColorFX}(MatrixFX.FX=FX),BasicColumnFX=function(_super){function BasicColumnFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.hueOffset=0,_this.colCount=0,_this.colHue=0,_this}return __extends(BasicColumnFX,_super),BasicColumnFX.prototype.resize=function(width,height){this.colCount=Math.ceil(width/Matrix.COLUMN_SIZE),this.colHue=360/this.colCount,this.canvas.width=this.colCount,this.canvas.height=1,this.draw()},BasicColumnFX.prototype.draw=function(){for(var x=0;x<this.colCount;x++)this.ctx.fillStyle=Utility.color_hsl(Utility.fixDegrees(this.hueOffset-this.colHue*x)),this.ctx.beginPath(),this.ctx.fillRect(x,0,1,1);this.hueOffset=Utility.fixDegrees(this.hueOffset+this.colHue)},BasicColumnFX}(FX),BasicDiagonalFX=function(_super){function BasicDiagonalFX(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.size=22,_this.hueOffset=0,_this.colHue=0,_this}return __extends(BasicDiagonalFX,_super),BasicDiagonalFX.prototype.resize=function(width,height){this.colHue=360/(width/Matrix.COLUMN_SIZE),this.canvas.width=this.size,this.canvas.height=this.size,this.draw()},BasicDiagonalFX.prototype.draw=function(){for(var gradient=this.ctx.createLinearGradient(0,0,this.size,this.size),i=0;i<1.1;i+=.1)gradient.addColorStop(Utility.fixFloat(i,10),Utility.color_hsl(Utility.fixDegrees(this.hueOffset-360/11*(10*i))));this.ctx.fillStyle=gradient,this.ctx.beginPath(),this.ctx.fillRect(0,0,this.size,this.size),this.hueOffset=Utility.fixDegrees(this.hueOffset+this.colHue)},BasicDiagonalFX}(FX);MatrixFX.BUILTIN_FX_COLOR=new BasicColorFX,MatrixFX.BUILTIN_FX_COLUMNS=new BasicColumnFX,MatrixFX.BUILTIN_FX_DIAGONAL=new BasicDiagonalFX}(MatrixFX=MatrixFX||{}),function(Matrix){Matrix.DEFAULT_COLOR="#44ff00",Matrix.DEFAULT_BACKGROUND_COLOR="#000",Matrix.DEFAULT_SYMBOLS="ｦｱｳｴｵｶｷｹｺｻｼｽｾｿﾀﾂﾃﾅﾆﾇﾈﾊﾋﾎﾏﾐﾑﾒﾓﾔﾕﾗﾘﾜ日(+*;)-|2589Z",Matrix.DEFAULT_SPEED=16,Matrix.DEFAULT_LINE_LENGTH=16,Matrix.DEFAULT_UPDATE_RATE=32,Matrix.DEFAULT_UPDATE_RATE_FX=32,Matrix.DEFAULT_FX=MatrixFX.BUILTIN_FX_COLOR,Matrix.DEFAULT_COMPOSITE_ALPHA=.3,Matrix.DEFAULT_COMPOSITE_MUTATION=!0,Matrix.DEFAULT_MOVE_CHANCE=.51,Matrix.DEFAULT_WAIT_TIME=3,Matrix.DEFAULT_MUTATION_CHANCE=.1,Matrix.DEFAULT_OVERLAY_MODE=1,Matrix.DEFAULT_LETTER_MUTATION_MODE=0,Matrix.DEFAULT_SCALE_X=1.2,Matrix.DEFAULT_SCALE_Y=1.2,Matrix.COLUMN_SIZE=12,Matrix.MAX_SPEED=32;var width,height,container,targetCanvas,targetCanvasCtx,fgCanvas,fgCtx,canvas,ctx,bgCanvas,bgCtx,bgColorCanvas,bgColorCtx,characters,characterSizes,created=!(Matrix.MAX_LINE_LENGTH=32),started=!1,scaleX=Matrix.DEFAULT_SCALE_X,scaleY=Matrix.DEFAULT_SCALE_Y;function convertSymbols(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),characterSizes=[];for(var i=0,l=(characters=_symbols).length;i<l;i++)characterSizes[i]=ctx.measureText(characters[i]).width/2}var RenderEngine,backgroundColor=Matrix.DEFAULT_BACKGROUND_COLOR,speed=Matrix.DEFAULT_SPEED,lineLength=Matrix.DEFAULT_LINE_LENGTH,ups=Matrix.DEFAULT_UPDATE_RATE,upsFX=Matrix.DEFAULT_UPDATE_RATE_FX,fx=Matrix.DEFAULT_FX,compositeAlpha=Matrix.DEFAULT_COMPOSITE_ALPHA,compositeMutation=Matrix.DEFAULT_COMPOSITE_MUTATION,moveChance=Matrix.DEFAULT_MOVE_CHANCE,mutationChance=Matrix.DEFAULT_MUTATION_CHANCE,overlayMode=Matrix.DEFAULT_OVERLAY_MODE,letterMutationMode=Matrix.DEFAULT_LETTER_MUTATION_MODE;function resize(){created?(width=container.clientWidth,height=container.clientHeight,targetCanvas.width=width,targetCanvas.height=height,fgCanvas.width=width,fgCanvas.height=height,canvas.width=width,canvas.height=height,bgCanvas.width=width,bgCanvas.height=height,bgColorCanvas.width=width,bgColorCanvas.height=height,fx.resize(width,height),RenderEngine.recalculate_columns()):console.error("Matrix : Cannot resize before creation.")}function resizeContainer(_width,_height){created?(container.style.width=_width,container.style.height=_height,resize()):console.error("Matrix : Cannot resize container before creation.")}Matrix.create=function(selector,size){(container=document.querySelector(selector))?(created=!0,container.style.overflow="hidden",targetCanvas=document.createElement("canvas"),targetCanvasCtx=targetCanvas.getContext("2d"),fgCanvas=document.createElement("canvas"),canvas=document.createElement("canvas"),bgCanvas=document.createElement("canvas"),bgColorCanvas=document.createElement("canvas"),container.append(targetCanvas),fgCtx=fgCanvas.getContext("2d"),ctx=canvas.getContext("2d"),bgCtx=bgCanvas.getContext("2d"),bgColorCtx=bgColorCanvas.getContext("2d"),convertSymbols(Matrix.DEFAULT_SYMBOLS),Matrix.DEFAULT_FX.setColor(Matrix.DEFAULT_COLOR),size?resizeContainer(size.width,size.height):resize()):console.error("Matrix : Could not find the container specified.")},Matrix.start=function(){started?console.error("Matrix : Cannot start twice."):(started=!0,resize(),RenderEngine.start())},Matrix.resize=resize,Matrix.resizeContainer=resizeContainer,Matrix.getContainer=function(){return container},Matrix.debug_fx=function(){if(started)throw new Error("Cannot debug fx if already started!");RenderEngine.debug_fx()},function(Settings){function checkCreated(settingName){if(!created)throw new Error('Cannot set setting "'+settingName+'" before creation!')}Settings.setColor=function(_color){return void 0===_color&&(_color=Matrix.DEFAULT_COLOR),Matrix.DEFAULT_FX.setColor(_color),this},Settings.getColor=function(){return Matrix.DEFAULT_FX.getColor()},Settings.setBackgroundColor=function(_backgroundColor){return void 0===_backgroundColor&&(_backgroundColor=Matrix.DEFAULT_BACKGROUND_COLOR),backgroundColor=_backgroundColor,bgColorCtx.fillStyle=backgroundColor,bgColorCtx.beginPath(),bgColorCtx.fillRect(0,0,width,height),fgCtx.fillStyle=backgroundColor,this},Settings.getBackgroundColor=function(){return backgroundColor},Settings.setSymbols=function(_symbols){void 0===_symbols&&(_symbols=Matrix.DEFAULT_SYMBOLS),checkCreated("symbols"),convertSymbols(_symbols),RenderEngine.recalculate_columns()},Settings.getSymbols=function(){return characters},Settings.setSpeed=function(_speed){void 0===_speed&&(_speed=Matrix.DEFAULT_SPEED),_speed>Matrix.MAX_SPEED&&(_speed=Matrix.DEFAULT_SPEED),speed=Math.max(1,_speed)},Settings.getSpeed=function(){return speed},Settings.setLineLength=function(_lineLength){void 0===_lineLength&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),(_lineLength<1||_lineLength>Matrix.MAX_LINE_LENGTH)&&(_lineLength=Matrix.DEFAULT_LINE_LENGTH),lineLength=_lineLength},Settings.getLineLength=function(){return lineLength},Settings.setUpdateRate=function(_ups){void 0===_ups&&(_ups=Matrix.DEFAULT_UPDATE_RATE),ups=Math.max(1,_ups)},Settings.getUpdateRate=function(){return ups},Settings.setUpdateRateFX=function(_upsFX){void 0===_upsFX&&(_upsFX=Matrix.DEFAULT_UPDATE_RATE_FX),upsFX=Math.max(1,_upsFX)},Settings.getUpdateRateFX=function(){return upsFX},Settings.setFX=function(_fx){void 0===_fx&&(_fx=Matrix.DEFAULT_FX),checkCreated("fx"),(fx=_fx).resize(width,height)},Settings.getFX=function(){return fx},Settings.setCompositeAlpha=function(_alpha){void 0===_alpha&&(_alpha=Matrix.DEFAULT_COMPOSITE_ALPHA),compositeAlpha=_alpha,fgCtx.globalAlpha=compositeAlpha},Settings.getCompositeAlpha=function(){return compositeAlpha},Settings.setCompositeMutation=function(_compositeMutation){compositeMutation=_compositeMutation},Settings.getCompositeMutation=function(){return compositeMutation},Settings.setMoveChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MOVE_CHANCE),moveChance=_chance},Settings.getMoveChance=function(){return moveChance},Settings.setMutationChance=function(_chance){void 0===_chance&&(_chance=Matrix.DEFAULT_MUTATION_CHANCE),mutationChance=_chance},Settings.getMutationChance=function(){return mutationChance},Settings.setOverlayMode=function(_overlayMode){void 0===_overlayMode&&(_overlayMode=Matrix.DEFAULT_OVERLAY_MODE),overlayMode=_overlayMode},Settings.getOverlayMode=function(){return overlayMode},Settings.setLetterMutationMode=function(_letterMutationMode){void 0===_letterMutationMode&&(_letterMutationMode=Matrix.DEFAULT_LETTER_MUTATION_MODE),letterMutationMode=_letterMutationMode},Settings.getLetterMutationMode=function(){return letterMutationMode},Settings.setScale=function(_scaleX,_scaleY){checkCreated("scale"),scaleX=Math.max(Matrix.DEFAULT_SCALE_X,_scaleX),scaleY=Math.max(Matrix.DEFAULT_SCALE_Y,_scaleY||_scaleX),RenderEngine.recalculate_columns()},Settings.getScale=function(){return[scaleX,scaleY]}}(Matrix.Settings||(Matrix.Settings={})),function(RenderEngine){var columns=[];function create_segment(){for(var hLineLength=lineLength/2,_length=Math.ceil(hLineLength+Math.random()*hLineLength),_letters=[],i=0;i<_length;i++)_letters.push(Math.floor(Math.random()*characters.length));return{delay:Math.ceil(5+15*Math.random()),y:-((_length+1)*Matrix.COLUMN_SIZE),eraseY:-(Math.ceil(_length+hLineLength)*Matrix.COLUMN_SIZE),letters:_letters,length:_length}}RenderEngine.recalculate_columns=function(){columns=[],paint_reset();for(var x=0;x<width;x+=Matrix.COLUMN_SIZE)columns.push({wait:Matrix.DEFAULT_WAIT_TIME+Math.round(Matrix.DEFAULT_WAIT_TIME*(1-moveChance)*Math.random()),x:x,segments:[create_segment()]})};var background,accumulatorRender=0,accumulatorFX=0;function render_columns(){1==overlayMode&&(ctx.clearRect(0,0,width,height),fgCtx.clearRect(0,0,width,height),fgCtx.beginPath(),fgCtx.fillRect(0,0,width,height));for(var _i=0,columns_1=columns;_i<columns_1.length;_i++){for(var l_Column=columns_1[_i],needsNext=!0,x=l_Column.x,_a=0,_b=l_Column.segments;_a<_b.length;_a++){var l_Segment=_b[_a];if(0<l_Segment.delay)needsNext=!1,--l_Segment.delay;else{0<l_Segment.length&&(needsNext=!1,--l_Segment.length),l_Segment.y+=Matrix.COLUMN_SIZE,bgCtx.beginPath(),bgCtx.clearRect(x,l_Segment.y,Matrix.COLUMN_SIZE,l_Segment.letters.length*Matrix.COLUMN_SIZE);for(var i=0,l=l_Segment.letters.length;i<l;i++){var y=l_Segment.y+Matrix.COLUMN_SIZE*i;!function(char,x,y){ctx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE),ctx.beginPath(),ctx.strokeText(characters[char],x+6-characterSizes[char],y+2,Matrix.COLUMN_SIZE)}(l_Segment.letters[i],x,y),i+1==l&&fgCtx.clearRect(x,y,Matrix.COLUMN_SIZE,Matrix.COLUMN_SIZE)}}}needsNext&&l_Column.segments.push(create_segment()),l_Column.segments=l_Column.segments.filter(function(segment){return segment.y-Matrix.COLUMN_SIZE*segment.length<height})}0==overlayMode&&(fgCtx.beginPath(),fgCtx.fillRect(0,0,width,height))}function render_composite_color(){ctx.globalCompositeOperation="source-atop",bgCtx.globalCompositeOperation="source-atop",fx.drawTo(ctx,width,height),fx.drawTo(bgCtx,width,height),ctx.globalCompositeOperation="source-over",bgCtx.globalCompositeOperation="source-over"}function render_process_debugFX(delta){1e3/upsFX<=accumulatorFX&&(accumulatorFX-=1e3/upsFX,ctx.fillRect(0,0,width,height),render_composite_color())}var render_process=function(delta){bgCtx.clearRect(0,0,width,height),bgCtx.globalAlpha=compositeAlpha,bgCtx.drawImage(background.html_canvas(),0,0),bgCtx.globalAlpha=1,render_columns(),render_composite_color(),targetCanvasCtx.drawImage(bgColorCanvas,0,0),targetCanvasCtx.drawImage(bgCanvas,0,0)};function paint_reset(){fgCtx.globalAlpha=compositeAlpha,fgCtx.resetTransform(),fgCtx.scale(scaleX,scaleY),ctx.clearRect(0,0,width,height),ctx.resetTransform(),ctx.scale(scaleX,scaleY),background&&background.resize(width,height),bgCtx.resetTransform(),bgCtx.scale(scaleX,scaleY),bgColorCtx.fillStyle=backgroundColor,bgColorCtx.resetTransform(),bgColorCtx.scale(scaleX,scaleY),bgColorCtx.beginPath(),bgColorCtx.fillRect(0,0,width,height)}RenderEngine.debug_fx=function(){render_process=render_process_debugFX},RenderEngine.start=function(){ctx.strokeStyle="#000",ctx.fillStyle="#000",background=new BGBuffer,paint_reset();var lastRender=0;window.requestAnimationFrame(function loop(timestamp){var delta=timestamp-lastRender;1e3/upsFX<=(accumulatorFX+=delta)&&(1e3/upsFX<=(accumulatorFX-=1e3/upsFX)&&(console.warn("Skipping "+Math.ceil(accumulatorFX/(1e3/upsFX))+" fx updates, is the update rate too fast?"),accumulatorFX=0),fx.draw()),1e3/ups<=(accumulatorRender+=delta)&&(1e3/ups<=(accumulatorRender-=1e3/ups)&&(console.warn("Skipping "+Math.ceil(accumulatorRender/(1e3/ups))+" render updates, is the update rate too fast?"),accumulatorRender=0),render_process(delta)),lastRender=timestamp,window.requestAnimationFrame(loop)})};var BGBuffer=function(_super){function BGBuffer(){var _this=_super.call(this)||this;return _this.ctx.fillStyle="#000",_this}return __extends(BGBuffer,_super),BGBuffer.prototype.resize=function(width,height){_super.prototype.resize.call(this,width,height),this.draw()},BGBuffer.prototype.draw=function(){this.ctx.clearRect(0,0,this.width(),this.height());for(var y=0;y<this.height();y+=Matrix.COLUMN_SIZE)for(var x=0;x<this.width();x+=Matrix.COLUMN_SIZE)this.ctx.beginPath(),this.ctx.fillRect(x+5,y+5,2,2)},BGBuffer}(Utility.Buffer)}(RenderEngine=RenderEngine||{})}(Matrix=Matrix||{});